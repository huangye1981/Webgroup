var app=angular.module("App",["ngRoute","ng.ueditor","ngAnimate","ngSanitize","ngTable","ngCookies","ui.bootstrap","ui.tree","ui.select","imageupload","angular-md5","xeditable","ez.confirm","ng-currency"]).constant("appCfg",{AdminPrefix:"/admin",AppPrefix:"",Sex:[{Id:1,Name:"男"},{Id:2,Name:"女"},{Id:3,Name:"保密"}],Status:[{Id:1,Name:"正常"},{Id:2,Name:"封杀"}]}).config(["$routeProvider","$httpProvider",function(a,b){b.defaults.transformRequest=function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},b.defaults.headers.post={"Content-Type":"application/x-www-form-urlencoded"};var c;c=["404","500","login","lock","init","admin/settings","admin/admin","admin/node","admin/ipban","admin/role","admin/logs","admin/mode"],c.forEach(function(b){var c,d,e;d="/"+b,e=!0,"login"!=b&&"404"!=b&&"505"!=b&&"lock"!=b||(e=!1),c={templateUrl:"/static/page/"+b+".html?"+version,login:e},a.when(d,c)}),a.when("/",{redirectTo:"/start"}).when("/admin/permission/:role_id",{templateUrl:"/static/page/admin/permission.html",controller:"PermissionCtrl"}).when("/admin/pnode/:role_id",{templateUrl:"/static/page/admin/pnode.html",controller:"PnodeCtrl"}).otherwise({redirectTo:"/404"})}]);app.controller("AdminCtrl",["$scope","$modal","$http","$filter","appCfg","EzConfirm","configService",function(a,b,c,d,e,f,g){a.search={Keyword:"",Start:"",End:"",PageSize:20,Page:1},a.getList=function(b){a.search.Page=b||a.search.Page;var f=e.AdminPrefix+"/admin/list";c.post(f,a.search).success(function(b,c,e,f){d("CheckError")(b)&&(a.listData=b.Data)})};var h;a.add=function(){h=b.open({templateUrl:"/static/page/modal/admin_edit.html?"+version,controller:"AdminEditCtrl",backdrop:!1,resolve:{curr_data:function(){return{OP:"add",Data:{Status:1,Sex:1,Photo:""}}}}}),h.result.then(function(b){a.getList(1)})},a.edit=function(f,g){var g=g||"edit",i=e.AdminPrefix+"/admin/edit/"+f;c.get(i).success(function(c,e,f,i){if(d("CheckError")(c)){var j=c.Data;j.Password="",j.ConfirmPassword="",j.Share=0==j.Share?1:j.Share,j.Birthday>0&&(j.Birthday=new Date(1e3*j.Birthday).Format("yyyy-MM-dd")),h=b.open({backdrop:!1,templateUrl:"/static/page/modal/admin_edit.html?"+version,controller:"AdminEditCtrl",resolve:{curr_data:function(){return{Op:g,Data:j}}}}),h.result.then(function(b){a.getList()})}})},a.del=function(b){f.create({heading:"管理员删除",text:"确定删除此管理员吗？"}).then(function(){var f=angular.copy(b),h=e.AdminPrefix+"/admin/del";c.post(h,f).success(function(b,c,e,f){d("CheckError")(b)&&(g.getConfig("Admin"),a.getList())})})},a.getList(a.search.Page)}]),app.controller("AdminEditCtrl",["$scope","$http","$modalInstance","$filter","configService","curr_data","appCfg",function(a,b,c,d,e,f,g){a.cancel=function(){c.dismiss("cancel")},a.reset=function(){a.editData=angular.copy(a.oldData)},a.change=function(b){if(0==b.length){for(var b in a.editData){if(!a.oldData.hasOwnProperty(b))return!0;if(a.oldData[b]!=a.editData[b])return!0}return!1}return!a.oldData.hasOwnProperty(b)||a.oldData[b]!=a.editData[b]},a.save=function(){var f=angular.copy(a.editData);h=[];for(var g in f.Role){var i=array_obj_find(a.roleData,"Name",f.Role[g]);i&&h.push(i.Id)}f.Role=h.join(","),console.log(f),b.post(a.postUrl,f).success(function(a,b,f,g){d("CheckError")(a)&&(e.getConfig("Admin"),c.close(a))})},a.roles=[],a.attrDef=[{Key:"Username",Title:"登录账号",InputType:"text",Required:"true"},{Key:"Password",Title:"密　　码",InputType:"password",Required:"true"},{Key:"ConfirmPassword",Title:"确认密码",InputType:"password",Required:"true"},{Key:"Status",Title:"状　　态",InputType:"radio",Value:[[1,"正常"],[2,"禁用"]],Required:"true"},{Key:"Role",Title:"角　　色",InputType:"select-multiple",Required:"false",Value:a.roles},{Key:"Photo",Title:"头　　像",InputType:"upload-img",Value:{Width:136,Height:136,Force:1,Quality:.7}},{Key:"Name",Title:"姓　　名",InputType:"text",Required:"true"},{Key:"Sex",Title:"性　　别",InputType:"radio",Value:[[1,"男"],[2,"女"]]},{Key:"Birthday",Title:"出生日期",InputType:"date",Required:"false",Id:"birthday_time",Format:"Y-m-d",Showtime:"false",Min:1960,Max:2010},{Key:"Email",Title:"邮　　箱",InputType:"email",Required:"false"},{Key:"IdentityId",Title:"身份证号",InputType:"text",Required:"false"},{Key:"Mobile",Title:"手机号码",InputType:"text",Required:"false"},{Key:"Address",Title:"现 住 址",InputType:"text",Required:"false"},{Key:"Note",Title:"备　　注",InputType:"textarea",Required:"false"}],a.checkData=function(){for(var b=angular.copy(a.attrDef),c=0;c<b.length;c++)if("true"==b[c].Required&&(angular.isUndefined(a.editData[b[c].Key])||""==a.editData[b[c].Key]))return!0;return!1},a.changeCallback=function(b){a.editData.Photo=b.resized.dataURL},a.title="添加新管理员",a.postUrl=g.AdminPrefix+"/admin/add",a.op=f.Op,a.oldData=angular.copy(f.Data),a.editData=angular.copy(a.oldData),a.roleData=[];var h=a.editData.Role?a.editData.Role.split(","):[];a.editData.Role=[],a.roleData=e.data.Role;for(var i in a.roleData)a.roles.push(a.roleData[i].Name);a.editData.Role=[];for(var i in h){var j=array_obj_find(a.roleData,"Id",h[i]);j&&a.editData.Role.push(j.Name)}"edit"==f.Op&&(a.title="编辑管理员信息",a.attrDef[1].Required="false",a.attrDef[2].Required="false",a.postUrl=g.AdminPrefix+"/admin/edit")}]),app.controller("HeaderCtrl",["$scope","$modal","$window","$location","LoginService","configService",function(a,b,c,d,e,f){var g;a.infoEdit=function(){var c=a.loginData.Admin;c.Password="",c.ConfirmPassword="",c.Birthday>0&&(c.Birthday=new Date(1e3*c.Birthday).Format("yyyy-MM-dd")),g=b.open({backdrop:!1,templateUrl:"/static/page/modal/info_edit.html?"+version,controller:"InfoEditCtrl",resolve:{curr_data:function(){return{Op:"edit",Data:c}}}}),g.result.then(function(a){e.data.Admin=a.Data})},a.logout=function(){e.logout()}}]),app.controller("InfoEditCtrl",["$scope","$http","$modalInstance","$filter","configService","curr_data","appCfg",function(a,b,c,d,e,f,g){a.cancel=function(){c.dismiss("cancel")},a.reset=function(){a.editData=angular.copy(a.oldData)},a.change=function(b){if(0==b.length){for(var b in a.editData){if(!a.oldData.hasOwnProperty(b))return!0;if(a.oldData[b]!=a.editData[b])return!0}return!1}return!a.oldData.hasOwnProperty(b)||a.oldData[b]!=a.editData[b]},a.save=function(){var f=angular.copy(a.editData);temp=[];for(var g in f.Role){var h=array_obj_find(a.roleData,"Name",f.Role[g]);h&&temp.push(h.Id)}f.Role=temp.join(","),console.log(f),b.post(a.postUrl,f).success(function(a,b,f,g){d("CheckError")(a)&&(e.getConfig("Admin"),c.close(a))})},a.roles=[],a.attrDef=[{Key:"Username",Title:"登录账号",InputType:"text",Required:"false"},{Key:"Password",Title:"密　　码",InputType:"password",Required:"true"},{Key:"ConfirmPassword",Title:"确认密码",InputType:"password",Required:"true"},{Key:"Status",Title:"状　　态",InputType:"radio",Value:[[1,"正常"],[2,"封杀"]],Required:"false"},{Key:"Role",Title:"角　　色",InputType:"select-multiple",Required:"false",Value:a.roles},{Key:"Photo",Title:"头　　像",InputType:"upload-img",Value:{Width:136,Height:136,Force:1,Quality:.7}},{Key:"Name",Title:"姓　　名",InputType:"text",Required:"true"},{Key:"Sex",Title:"性　　别",InputType:"radio",Value:[[1,"男"],[2,"女"]]},{Key:"Birthday",Title:"出生日期",InputType:"date",Required:"false",Id:"birthday_time",Format:"Y-m-d",Showtime:"false",Min:1960,Max:2010},{Key:"Email",Title:"邮　　箱",InputType:"email",Required:"false"},{Key:"IdentityId",Title:"身份证号",InputType:"text",Required:"false"},{Key:"Mobile",Title:"手机号码",InputType:"text",Required:"false"},{Key:"Address",Title:"现 住 址",InputType:"text",Required:"false"},{Key:"Note",Title:"备　　注",InputType:"textarea",Required:"false"}],a.checkData=function(){for(var b=angular.copy(a.attrDef),c=0;c<b.length;c++)if("true"==b[c].Required&&(angular.isUndefined(a.editData[b[c].Key])||""==a.editData[b[c].Key]))return!0;return!1},a.changeCallback=function(b){a.editData.Photo=b.resized.dataURL},a.title="个人信息",a.op=f.Op,a.oldData=angular.copy(f.Data),a.editData=angular.copy(a.oldData),a.attrDef[1].Required="false",a.attrDef[2].Required="false",a.postUrl=g.AdminPrefix+"/public/info"}]),app.controller("InitCtrl",["$scope","$rootScope","$location","$http","LoginService","appCfg","EzConfirm",function(a,b,c,d,e,f,g){var h;h=$(window),a.admin={name:appname,layout:!1,menu:!1,fixedHeader:!0,fixedSidebar:!0,themeID:"32",navbarHeaderColor:"bg-primary",navbarlogo:"bg-primary",asideColor:"bg-white",show:!1},a.color={primary:"#248AAF",success:"#3CBC8D",info:"#29B7D3",purple:"#7266ba",warning:"#FAC552",danger:"#E9422E"},a.lang="cn",e.reLogin(),a.loginData=e.data,a.checkPermission=e.checkPermission,a.checkSystem=e.checkSystem}]),app.controller("IpbanCtrl",["$scope","$http","$modal","$filter","appCfg","EzConfirm",function(a,b,c,d,e,f){a.search={Keyword:"",Start:"",PageSize:20,Page:1},a.getList=function(c){a.search.Page=c||a.search.Page;var f=e.AdminPrefix+"/ipban/list";b.post(f,a.search).success(function(b,c,e,f){d("CheckError")(b)&&(a.listData=b.Data)})};var g;a.add=function(){g=c.open({backdrop:!1,templateUrl:"/static/page/modal/base.html?"+version,controller:"IpbanEditCtrl",backdrop:!1,resolve:{curr_data:function(){return{Op:"add",Data:{Start:(new Date).Format("yyyy-MM-dd H:i"),End:(new Date).Format("yyyy-MM-dd hh:mm"),Status:1}}}}}),g.result.then(function(b){a.getList(1)})},a.edit=function(f,h){var h=h||"edit",i=e.AdminPrefix+"/ipban/edit/"+f;b.get(i).success(function(b,e,f,i){if(d("CheckError")(b)){var j=b.Data;j.Start=new Date(1e3*j.Start).Format("yyyy-MM-dd hh:mm"),j.End=new Date(1e3*j.End).Format("yyyy-MM-dd hh:mm"),g=c.open({backdrop:!1,templateUrl:"/static/page/modal/base.html?"+version,controller:"IpbanEditCtrl",resolve:{curr_data:function(){return{Op:h,Data:j}}}}),g.result.then(function(b){a.getList()})}})},a.del=function(c){f.create({heading:"IP删除",text:"确定删除此IP吗？"}).then(function(){var f=angular.copy(c),g=e.AdminPrefix+"/ipban/del";b.post(g,f).success(function(b,c,e,f){d("CheckError")(b)&&a.getList()})})},a.getList()}]),app.controller("IpbanEditCtrl",["$scope","$http","$filter","$modalInstance","curr_data","appCfg",function(a,b,c,d,e,f){a.cancel=function(){d.dismiss("cancel")},a.reset=function(){a.editData=angular.copy(a.oldData)},a.change=function(b){if(0==b.length){for(var b in a.editData){if(!a.oldData.hasOwnProperty(b))return!0;if(a.oldData[b]!=a.editData[b])return!0}return!1}return!a.oldData.hasOwnProperty(b)||a.oldData[b]!=a.editData[b]},a.save=function(){b.post(a.postUrl,a.editData).success(function(a,b,e,f){c("CheckError")(a)&&d.close(a)})},a.attrDef=[{Key:"Ip",Title:"屏蔽IP",InputType:"text",Required:"true"},{Key:"Start",Title:"开始时间",InputType:"date",Required:"true",Id:"ipban_datetime_start",Format:"Y-m-d H:i"},{Key:"End",Title:"结束时间",InputType:"date",Required:"true",Id:"ipban_datetime_end",Format:"Y-m-d H:i"},{Key:"Description",Title:"备　注",InputType:"textarea"}],a.title="添加屏蔽IP",a.postUrl=f.AdminPrefix+"/ipban/add",a.op=e.Op,a.oldData=angular.copy(e.Data),a.editData=angular.copy(a.oldData),"edit"==e.Op&&(a.title="编辑屏蔽IP",a.postUrl=f.AdminPrefix+"/ipban/edit")}]),app.controller("LockCtrl",["$scope","$window","$location","LoginService",function(a,b,c,d){d.data.Lock=1,a.unLock=function(){d.unlock(a.lockpassword)&&b.history.back()}}]),app.controller("LoginCtrl",["$scope","$location","$filter","LoginService",function(a,b,c,d){a.data={Msg:"输入账号和密码进行登录",Username:"",Password:"",Remember:!1},a.login=function(){d.login(a.data.Username,a.data.Password,a.data.Remember).success(function(d,e,f,g){c("CheckError")(d)?b.path("/"):a.data.Msg=d.Msg})}}]),app.controller("LogsCtrl",["$scope","$http","$filter","appCfg","configService","EzConfirm",function(a,b,c,d,e,f){a.config=e.data,a.search={Keyword:"",Start:"",PageSize:20,Page:1},a.getList=function(e){a.search.Page=e||a.search.Page;var f=d.AdminPrefix+"/logs/list";b.post(f,a.search).success(function(b,d,e,f){c("CheckError")(b)&&(a.listData=b.Data)})},a.clear=function(){f.create({heading:"日志清除",text:"确定清除全部日志吗？"}).then(function(){b.get(d.AdminPrefix+"/logs/clear").success(function(b,c,d,e){a.getList(1)})})},a.getList(a.currentPage)}]),app.controller("ModeCtrl",["$scope","$http","$filter","$modal","appCfg","configService","EzConfirm",function(a,b,c,d,e,f,g){a.search={Keyword:""},a.getList=function(){var d=e.AdminPrefix+"/mode/list";b.post(d,a.search).success(function(b,d,e,f){c("CheckError")(b)&&(a.list={},a.list=list_2_tree(a.list,b.Data,1),a.list=a.list.Childs)})};var h;a.add=function(b,c){var b=b||-1,c=c||0;h=d.open({backdrop:!1,templateUrl:"/static/page/modal/base.html",controller:"ModeEditCtrl",backdrop:!1,resolve:{curr_data:function(){return{Op:"add",Data:{Func:c,Type:1,ParentId:b,Sort:100,Logs:1}}}}}),h.result.then(function(b){a.getList(1)})},a.edit=function(f,g){var g=g||"edit",i=e.AdminPrefix+"/mode/edit/"+f;b.get(i).success(function(b,e,f,i){c("CheckError")(b)&&(h=d.open({backdrop:!1,templateUrl:"/static/page/modal/base.html",controller:"ModeEditCtrl",resolve:{curr_data:function(){return{Op:g,Data:b.Data}}}}),h.result.then(function(b){a.getList()}))})},a.del=function(d){g.create({heading:"模块删除",text:"确定删除此模块吗？"}).then(function(){var g=e.AdminPrefix+"/mode/del";b.post(g,d).success(function(b,d,e,g){c("CheckError")(b)&&(a.getList(),f.getConfig("Mode"))})})},a.getList()}]),app.controller("ModeEditCtrl",["$scope","$http","$filter","$modalInstance","curr_data","appCfg","configService","LoginService",function(a,b,c,d,e,f,g,h){a.cancel=function(){d.dismiss("cancel")},a.reset=function(){a.editData=angular.copy(a.oldData)},a.change=function(b){if(0==b.length){for(var b in a.editData){if(!a.oldData.hasOwnProperty(b))return!0;if(a.oldData[b]!=a.editData[b])return!0}return!1}return!a.oldData.hasOwnProperty(b)||a.oldData[b]!=a.editData[b]},a.save=function(){b.post(a.postUrl,a.editData).success(function(a,b,e,f){c("CheckError")(a)&&(g.getConfig("Mode"),d.close(a))})},a.attrDef=[{Key:"Type",Title:"模块类型",InputType:"radio",Value:[[1,"项目模块"],[2,"系统模块"]]},{Key:"Name",Title:"模块名称",InputType:"text",Required:"true"},{Key:"Key",Title:"模块别名",InputType:"text",Required:"true"},{Key:"Sort",Title:"模块排序",InputType:"text-i",Required:"true"},{Key:"Description",Title:"模块备注",InputType:"textarea"}],a.title="添加模块",a.postUrl=f.AdminPrefix+"/mode/add",a.op=angular.copy(e.Op),a.oldData=angular.copy(e.Data),a.editData=angular.copy(a.oldData),(a.oldData.ParentId>0||1==a.oldData.Func)&&(a.attrDef=[{Key:"Name",Title:"模块名称",InputType:"text",Required:"true"},{Key:"Key",Title:"模块别名",InputType:"text",Required:"true"},{Key:"Sort",Title:"模块排序",InputType:"text-i",Required:"true"},{Key:"Logs",Title:"日志跟踪",InputType:"radio",Value:[[1,"跟踪"],[2,"不跟踪"]]},{Key:"Description",Title:"模块备注",InputType:"textarea"}]),"edit"==e.Op&&(a.title="编辑模块",a.postUrl=f.AdminPrefix+"/mode/edit")}]),app.controller("NodeCtrl",["$scope","$http","$filter","$modal","appCfg","LoginService","EzConfirm",function(a,b,c,d,e,f,g){a.getNode=function(){a.list=[];var d=e.AdminPrefix+"/node/list";b.get(d).success(function(b,d,e,f){c("CheckError")(b)&&(a.list=list_2_tree(a.list,b.Data,1),a.list=a.list.Childs)})};var h;a.add=function(b){h=d.open({templateUrl:"/static/page/modal/base.html?"+version,controller:"NodeEditCtrl",backdrop:!1,resolve:{curr_data:function(){return{Op:"add",Data:{ParentId:b,Sort:100}}}}}),h.result.then(function(b){c("CheckError")(b)&&a.getNode()})},a.edit=function(f,g){var g=g||"edit",i=e.AdminPrefix+"/node/edit/"+f;b.get(i).success(function(b,e,f,i){c("CheckError")(b)&&(h=d.open({templateUrl:"/static/page/modal/base.html?"+version,controller:"NodeEditCtrl",resolve:{curr_data:function(){return{Op:g,Data:b.Data}}}}),h.result.then(function(b){a.getNode()}))})},a.del=function(d){g.create({text:"确定删除此节点吗？"}).then(function(){b.post(e.AdminPrefix+"/node/del/",d).success(function(b,d,e,g){c("CheckError")(b)&&(a.getNode(),f.reLogin())})})},a.getNode()}]),app.controller("NodeEditCtrl",["$scope","$http","$filter","$modalInstance","curr_data","appCfg","configService","LoginService",function(a,b,c,d,e,f,g,h){a.cancel=function(){d.dismiss("cancel")},a.reset=function(){a.editData=angular.copy(a.oldData)},a.change=function(b){if(0==b.length){for(var b in a.editData){if(!a.oldData.hasOwnProperty(b))return!0;if(a.oldData[b]!=a.editData[b])return!0}return!1}return!a.oldData.hasOwnProperty(b)||a.oldData[b]!=a.editData[b]},a.save=function(){b.post(a.postUrl,a.editData).success(function(a,b,e,f){c("CheckError")(a)&&(g.getConfig("Node"),h.reLogin(),d.close(a))})},a.attrDef=[{Key:"Name",Title:"节点名称",InputType:"text"},{Key:"Icon",Title:"Icon图标",InputType:"text"},{Key:"Sort",Title:"排序编号",InputType:"text"},{Key:"Description",Title:"备注说明",InputType:"textarea",Value:{Rows:4}}],a.title="添加节点",a.postUrl=f.AdminPrefix+"/node/add",a.op=angular.copy(e.Op),a.oldData=angular.copy(e.Data),a.editData=angular.copy(a.oldData),a.oldData.ParentId>0&&(a.attrDef=[{Key:"Name",Title:"节点名称",InputType:"text"},{Key:"Url",Title:"链接地址",InputType:"text"},{Key:"Sort",Title:"排序编号",InputType:"text"},{Key:"Description",Title:"备注说明",InputType:"textarea",Value:{Rows:4}}]),"edit"==e.Op&&(a.title="编辑节点",a.postUrl=f.AdminPrefix+"/node/edit")}]),app.controller("PermissionCtrl",["$scope","$log","$window","$modal","$routeParams","$http","$filter","appCfg","LoginService","EzConfirm",function(a,b,c,d,e,f,g,h,i,j){a.roleId=parseInt(e.role_id),f.get(h.AdminPrefix+"/role/view/"+a.roleId).success(function(b,c,d,e){if(a.code=b.Code,g("CheckError")(b)){a.roleData=b.Data.Role,a.roleData.Permission=a.roleData.Permission||"[]",a.roleData.Permission=angular.fromJson(a.roleData.Permission),a.modeData=b.Data.Mode,a.list={},a.list=list_2_tree(a.list,a.modeData,1),a.list=a.list.Childs;for(var f in a.list)for(var h in a.list[f].Childs)angular.isUndefined(a.roleData.Permission[a.list[f].Key])?(a.roleData.Permission[a.list[f].Key]={},a.roleData.Permission[a.list[f].Key][a.list[f].Childs[h].Key]=!1):angular.isUndefined(a.roleData.Permission[a.list[f].Key][a.list[f].Childs[h].Key])&&(a.roleData.Permission[a.list[f].Key][a.list[f].Childs[h].Key]=!1)}}),a.save=function(){var b={Id:a.roleData.Id,Permission:angular.toJson(angular.copy(a.roleData.Permission))};f.post(h.AdminPrefix+"/role/permission/",b).success(function(c,d,e,f){g("CheckError")(c)&&("root"!=a.loginData.Role&&array_obj_find(a.loginData.Role,"Id",b.Id)!==!1&&i.reLogin(),j.create({text:"权限数据保存成功！",hiddenFoot:!0}))})},a.del=function(a){j.create({text:"确定删除此权限吗？"}).then(function(){f.get(h.AdminPrefix+"/role/del/"+a).success(function(a,b,d,e){if(g("CheckError")(a))return c.history.back()})})},a.select=function(b){for(var c in a.roleData.Permission[b.target.id])a.roleData.Permission[b.target.id][c]=b.target.checked}}]),app.controller("PnodeCtrl",["$scope","$window","$http","$filter","$modal","$routeParams","appCfg","LoginService","EzConfirm",function(a,b,c,d,e,f,g,h,i){a.select={},a.system={},c.get(g.AdminPrefix+"/role/view/"+parseInt(f.role_id)).success(function(b,c,e,f){if(d("CheckError")(b)){a.roleData=b.Data.Role;var g=a.roleData.Node.split(",");for(var h in g)a.select[g[h]]=!0;g=a.roleData.System.split(",");for(var h in g)a.system[g[h]]=!0}}),a.getNode=function(){a.list=[];var b=g.AdminPrefix+"/node/list";c.get(b).success(function(b,c,e,f){d("CheckError")(b)&&(a.itemList=b.Data,a.list=list_2_tree(a.list,a.itemList,1),a.list=a.list.Childs)})},a.save=function(){var b=[];for(var e in a.select)a.select[e]&&b.push(e);var f=[];for(var e in a.system)a.system[e]&&f.push(e);var j={Id:a.roleData.Id,Node:b.join(","),System:f.join(",")};c.post(g.AdminPrefix+"/role/node/",j).success(function(a,b,c,e){d("CheckError")(a)&&(h.reLogin(),i.create({text:"节点数据保存成功！",hiddenFoot:!0}))})},a.getNode()}]),app.controller("RoleCtrl",["$scope","$http","$filter","$modal","appCfg","EzConfirm",function(a,b,c,d,e,f){a.search={Keyword:"",Start:"",End:"",PageSize:20,Page:1},a.getList=function(d){a.search.Page=d||a.search.Page;var f=e.AdminPrefix+"/role/list";b.post(f,a.search).success(function(b,d,e,f){c("CheckError")(b)&&(a.listData=b.Data)})};var g;a.add=function(){g=d.open({templateUrl:"/static/page/modal/base.html?"+version,controller:"RoleEditCtrl",backdrop:!1,resolve:{curr_data:function(){return{OP:"add",Data:{}}}}}),g.result.then(function(b){a.getList(1)})},a.edit=function(f,h){var h=h||"edit",i=e.AdminPrefix+"/role/edit/"+f;b.get(i).success(function(b,e,f,i){if(c("CheckError")(b)){var j=b.Data;j.Password="",j.ConfirmPassword="",g=d.open({backdrop:!1,templateUrl:"/static/page/modal/base.html?"+version,controller:"RoleEditCtrl",resolve:{curr_data:function(){return{Op:h,Data:j}}}}),g.result.then(function(b){a.getList()})}})},a.del=function(d){f.create({heading:"管理员删除",text:"确定删除此管理员吗？"}).then(function(){var f=angular.copy(d),g=e.AdminPrefix+"/role/del";b.post(g,f).success(function(b,d,e,f){c("CheckError")(b)&&a.getList()})})},a.getList(a.search.Page)}]),app.controller("RoleEditCtrl",["$scope","$http","$filter","$modalInstance","curr_data","appCfg",function(a,b,c,d,e,f){a.cancel=function(){d.dismiss("cancel")},a.reset=function(){a.editData=angular.copy(a.oldData)},a.change=function(b){if(0==b.length){for(var b in a.editData){if(!a.oldData.hasOwnProperty(b))return!0;if(a.oldData[b]!=a.editData[b])return!0}return!1}return!a.oldData.hasOwnProperty(b)||a.oldData[b]!=a.editData[b]},a.save=function(){b.post(a.postUrl,a.editData).success(function(a,b,e,f){c("CheckError")(a)&&d.close(a)})},a.attrDef=[{Key:"Name",Title:"名称",InputType:"text",Required:"true"},{Key:"Description",Title:"备注",InputType:"textarea"}],a.title="添加角色",a.postUrl=f.AdminPrefix+"/role/add",a.op=e.Op,a.oldData=angular.copy(e.Data),a.editData=angular.copy(a.oldData),"edit"==e.Op&&(a.title="编辑角色",a.postUrl=f.AdminPrefix+"/role/edit")}]),app.directive("collapseNav",[function(){return{restrict:"A",link:function(a,b){var c,d,e,f,g,h,i,j,k;i=$(window),f=b.find("ul").parent("li"),c=f.children("a"),g=b.children("li").not(f),d=g.children("a"),e=$("#app"),h=$("#nav-container"),c.on("click",function(a){var b,c;return!(e.hasClass("nav-collapsed-min")||h.hasClass("nav-horizontal")&&i.width()>=768)&&(c=$(this),b=c.parent("li"),console.log(b),f.not(b).removeClass("open").find("ul").slideUp(),b.toggleClass("open").find("ul").slideToggle(),void a.preventDefault())}),d.on("click",function(){return f.removeClass("open").find("ul").slideUp()}),a.$on("nav:reset",function(){return f.removeClass("open").find("ul").slideUp()}),j=i.width(),k=function(){var a;return a=i.width(),768>a&&e.removeClass("nav-collapsed-min"),768>j&&a>=768&&h.hasClass("nav-horizontal")&&f.removeClass("open").find("ul").slideUp(),j=a},i.resize(function(){var a;return clearTimeout(a),a=setTimeout(k,300)})}}}]),app.directive("customPage",[function(){return{restrict:"A",controller:["$scope","$element","$location",function(a,b,c){var d,e;return e=function(){return c.path()},d=function(a){switch(b.removeClass("body-wide body-lock"),a){case"/404":case"/404":case"/500":case"/login":return b.addClass("body-wide");case"/lock":return b.addClass("body-wide body-lock")}},d(c.path()),a.$watch(e,function(a,b){return a!==b?d(c.path()):void 0})}]}}]),app.directive("draggable",["$document",function(a){return function(b,c,d){function e(a){j=a.pageY-h,i=a.pageX-g,c.css({top:j+"px",left:i+"px"})}function f(){a.off("mousemove",e),a.off("mouseup",f)}var g=0,h=0,i=0,j=0;c=angular.element(document.getElementsByClassName("modal-dialog")),c.css({position:"relative",cursor:"move"}),c.on("mousedown",function(b){var c=b.target.id;c.indexOf("draggable")>-1&&(g=b.pageX-i,h=b.pageY-j,a.on("mousemove",e),a.on("mouseup",f))})}}]),app.directive("datetimepicker",[function(){return{restrict:"EA",require:"ngModel",link:function(a,b,c,d){function e(a){d.$setViewValue(a),f()}var f=a.$watch(function(){var e=d.$modelValue||"";return $(b).append("<input id='date-"+c.dateid+"' class='"+c.dateclass+"' placeholder='"+c.placeholder+"' value='"+e+"'>"),$(b).css("padding","0"),$("#date-"+c.dateid).datetimepicker({format:c.format||"Y-m-d H:i",lang:c.lang||"ch",step:c.step||15,hours12:"true"==c.hours12,timepicker:"false"!=c.showtime,yearStart:c.min||2e3,yearEnd:c.max||2050,onClose:function(){b.change()}}),b.on("change",function(){a.$apply(function(){d.$setViewValue($("#date-"+c.dateid).val())})}),b.on("click",function(){$("#date-"+c.dateid).datetimepicker({format:c.format||"Y-m-d H:i",onClose:function(){b.change()}})}),d.$modelValue},e)}}}]),app.directive("fullscreenMode",[function(){return{restrict:"A",template:'<a href="javascript:void(0)" ng-click="toggleFullscreen()" class="expand" id="toggle-fullscreen"> <i class="fa fa-expand"></i> </a>',controller:["$scope",function(a){a.toggleFullscreen=function(){$(document).toggleFullScreen(),$("#toggle-fullscreen .fa").toggleClass("fa-expand fa-compress")}}]}}]).directive("uiSpinner",[function(){return{restrict:"A",compile:function(a){return a.addClass("ui-spinner"),{post:function(){return a.spinner()}}}}}]),app.directive("goBack",[function(){return{restrict:"AE",controller:["$scope","$element","$window",function(a,b,c){return b.on("click",function(){return c.history.back()})}]}}]),app.directive("i18n",["localize",function(a){var b;return b={restrict:"EA",updateText:function(b,c,d){var e;return e=void 0,e=void 0,"i18n-placeholder"===c?(e=a.getLocalizedString(d),b.attr("placeholder",e)):c.length>=1?(e=a.getLocalizedString(c),b.text(e)):void 0},link:function(a,c,d){return a.$on("localizeResourcesUpdated",function(){return b.updateText(c,d.i18n,d.placeholder)}),d.$observe("i18n",function(a){return b.updateText(c,a,d.placeholder)})}}}]),app.directive("slimScroll",[function(){return{restrict:"A",link:function(a,b,c){return b.slimScroll({height:c.scrollHeight||"100%"})}}}]),app.directive("toggleNavCollapsedMin",["$rootScope",function(a){return{restrict:"A",link:function(b,c){var d;return d=$("#app"),c.on("click",function(b){return d.hasClass("nav-collapsed-min")?d.removeClass("nav-collapsed-min"):(d.addClass("nav-collapsed-min"),a.$broadcast("nav:reset")),b.preventDefault()})}}}]),app.directive("toggleProfile",[function(){return{restrict:"A",template:'<a href="javascript:void(0)" ng-click="toggleProfile()"> <i class="fa fa-user"></i> </a>',controller:["$scope",function(a){a.toggleProfile=function(){$("#settings").slideToggle()}}]}}]),app.directive("uiEditObj",[function(){return{restrict:"AE",replace:!0,scope:{attrDef:"=setAttrDef",editData:"=setEditData",oldData:"=setOldData",change:"&",changeSelect:"&",changeTreeMultipleSel:"&",changeGoodsTypeAttr:"&",changeCallback:"&"},templateUrl:"/static/page/modal/ui_edit_obj.html?"+version,controller:["$scope",function(a){}]}}]),app.factory("localize",["$http","$rootScope","$window",function(a,b,c){var d;return d={language:"",resourceFileLoaded:!1,successCallback:function(a){return d.dictionary=a,d.resourceFileLoaded=!0,b.$broadcast("localizeResourcesUpdated")},setLanguage:function(a){return d.language=a.toLowerCase().split("-")[0],d.initLocalizedResources()},setUrl:function(a){return d.url=a,d.initLocalizedResources()},buildUrl:function(){return d.language||(d.language=(c.navigator.userLanguage||c.navigator.language).toLowerCase(),d.language=d.language.split("-")[0]),"i18n/resources-locale_"+d.language+".js"},initLocalizedResources:function(){var c;return c=d.url||d.buildUrl(),a({method:"GET",url:c,cache:!1}).success(d.successCallback).error(function(){return b.$broadcast("localizeResourcesUpdated")})},getLocalizedString:function(a){var b,c;return d.dictionary&&a?(c=a.toLowerCase(),b=""===d.dictionary[c]?a:d.dictionary[c]):b=a,b}}}]),app.filter("AlertError",["EzConfirm",function(a){return function(b){a.create({heading:"错误提示",text:b,cancelBtn:"",confirmBtn:"知道了"})}}]),app.filter("AppCfgFind",["appCfg",function(a){return function(b,c){return array_obj_find(a[c],"Id",b).Name}}]),app.filter("ArrayObjArray",[function(){return function(a,b,c){return 0==c||""==c||angular.isUndefined(c)||null==c?a:array_obj_array(a,b,c)}}]),app.filter("ArrayObjFind",[function(){return function(a,b,c,d){d=d||"Name";var e=array_obj_find(b,c,a)[d]||"无";return e}}]),app.filter("CheckError",["EzConfirm",function(a){return function(b){return 1==b.Code||(a.create({heading:"错误提示",text:b.Msg,cancelBtn:"",confirmBtn:"知道了"}),!1)}}]),app.filter("FindName",[function(){return function(a,b,c){c=c||"Name";var d=array_obj_find(b,"Id",a)[c]||"无";return d}}]),app.filter("PropsFilter",[function(){return function(a,b){var c;return c=[],angular.isArray(a)?a.forEach(function(a){var d,e,f,g,h;for(e=!1,f=Object.keys(b),d=0;d<f.length;){if(g=f[d],h=b[g].toLowerCase(),-1!==a[g].toString().toLowerCase().indexOf(h)){e=!0;break}d++}e&&c.push(a)}):c=a,c}}]),app.filter("Split",[function(){return function(a,b){return a=a||"",a.split(b)}}]),app.service("configService",["$rootScope","$http","$filter","appCfg",function(a,b,c,d){var e=this;this.data={Admin:[],Role:[],Mode:[],Node:[]},this.getConfig=function(a){var f=d.AdminPrefix+"/public/config";return angular.isDefined(a)&&""!=a&&(f=d.AdminPrefix+"/public/config/"+a),b.get(f).success(function(b,d,f,g){1==b.Code?angular.isDefined(a)&&""!=a?e.data[a]=b.Data:e.data=b.Data:c("AlertError")(b.Msg)})},this.getConfig()}]),app.service("LoginService",["$rootScope","$window","$http","$location","md5","appCfg",function(a,b,c,d,e,f){var g={data:{Code:0,Admin:{},Lock:0,Nav:[],Role:""},login:function(a,d,e){var h=f.AdminPrefix+"/login/login",i={Username:a,Password:d};return c.post(h,i).success(function(c,f,h,i){if(1==c.Code){if(g.data.Code=c.Code,g.data.Admin=c.Data.Admin,c.Data.Nav=c.Data.Nav||[],g.data.Nav=[],g.data.Nav=list_2_tree(g.data.Nav,c.Data.Nav,1),g.data.Nav=g.data.Nav.Childs,g.data.Role=c.Data.Role,"root"!=g.data.Role)for(var j in g.data.Role)g.data.Role[j].Permission=angular.fromJson(g.data.Role[j].Permission||{}),g.data.Role[j].System=g.data.Role[j].System.split(",");e&&(b.localStorage.Username=a,b.localStorage.Password=d)}})},reLogin:function(){return console.log("重新登录"),c.get(f.AdminPrefix+"/login/islogin/").success(function(a,c,e,f){if(1==a.Code){if(g.data.Code=a.Code,g.data.Admin=a.Data.Admin,a.Data.Nav=a.Data.Nav||[],g.data.Nav=[],g.data.Nav=list_2_tree(g.data.Nav,a.Data.Nav,1),g.data.Nav=g.data.Nav.Childs,g.data.Role=a.Data.Role,"root"!=g.data.Role)for(var h in g.data.Role)g.data.Role[h].Permission=angular.fromJson(g.data.Role[h].Permission||{}),g.data.Role[h].System=g.data.Role[h].System.split(",")}else{var i=b.localStorage.Username||"",j=b.localStorage.Password||"";""!=i&&""!=j||d.path("/login"),g.login(i,j,!0)}})},logout:function(){b.localStorage.Username="",b.localStorage.Password="",c.get(f.AdminPrefix+"/login/logout/").success(function(a,b,c,e){1==a.Code&&(g.data.Code=0,g.data.Admin={},g.data.Nav=[],g.data.Role="",d.path("/login"))})},isLogin:function(){return""!=g.data.Admin.Id},unlock:function(a){return e.createHash(a)==g.data.Admin.Password&&(g.data.Lock=0,!0)},checkPermission:function(a,b){if("root"==g.data.Role)return!0;for(var c in g.data.Role)if(!angular.isUndefined(g.data.Role[c].Permission[a])&&!angular.isUndefined(g.data.Role[c].Permission[a][b])&&g.data.Role[c].Permission[a][b])return!0;return!1},checkSystem:function(a){if("root"==g.data.Role)return!0;for(var b in g.data.Role)if(g.data.Role[b].System.indexOf(a)>-1)return!0;return!1}};return g}]);